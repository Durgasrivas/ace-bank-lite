user:
  # Updated to fetch essential session data
  login_details: >
    SELECT u.USER_ID, u.FIRST_NAME, u.LAST_NAME, u.EMAIL, a.BALANCE 
    FROM USERS u 
    JOIN ACCOUNTS a ON u.USER_ID = a.USER_ID 
    WHERE a.ACCOUNT_NO = ? AND u.PASSWORD_HASH = ?
  signup: "INSERT INTO USERS (FIRST_NAME, LAST_NAME, AADHAAR_NO, EMAIL, PASSWORD_HASH) VALUES (?,?,?,?,?)"
  recover_details: >
    SELECT u.FIRST_NAME, u.LAST_NAME, a.ACCOUNT_NO 
    FROM USERS u 
    JOIN ACCOUNTS a ON u.USER_ID = a.USER_ID 
    WHERE u.EMAIL = ?
  get_password_by_acc: >
    SELECT u.PASSWORD_HASH 
    FROM USERS u 
    JOIN ACCOUNTS a ON u.USER_ID = a.USER_ID 
    WHERE a.ACCOUNT_NO = ?
  # Fetches everything we need for the session in one go
  get_details: >
    SELECT u.FIRST_NAME, u.LAST_NAME, u.EMAIL, a.BALANCE, a.ACCOUNT_NO 
    FROM USERS u 
    JOIN ACCOUNTS a ON u.USER_ID = a.USER_ID 
    WHERE a.ACCOUNT_NO = ?

  # Updates the password hash for the user linked to this account
  update_password: >
    UPDATE USERS u
    JOIN ACCOUNTS a ON u.USER_ID = a.USER_ID
    SET u.PASSWORD_HASH = ?
    WHERE a.ACCOUNT_NO = ?

account:
  create: "INSERT INTO ACCOUNTS (ACCOUNT_NO, USER_ID, BALANCE) VALUES (?,?,0.00)"
  withdraw: "UPDATE ACCOUNTS SET BALANCE = BALANCE - ? WHERE ACCOUNT_NO = ? AND BALANCE >= ?"
  deposit: "UPDATE ACCOUNTS SET BALANCE = BALANCE + ? WHERE ACCOUNT_NO = ?"
  check_pw: >
    SELECT u.PASSWORD_HASH, u.USER_ID FROM USERS u 
    JOIN ACCOUNTS a ON u.USER_ID = a.USER_ID WHERE a.ACCOUNT_NO = ?
  get_balance: "SELECT BALANCE FROM ACCOUNTS WHERE ACCOUNT_NO = ?"
  withdraw_balance: "UPDATE ACCOUNTS SET BALANCE = BALANCE - ? WHERE ACCOUNT_NO = ? AND BALANCE >= ?"


transaction:
  log: "INSERT INTO TRANSACTIONS (SENDER_ACCOUNT, RECEIVER_ACCOUNT, AMOUNT, TX_TYPE, REMARK) VALUES (?, ?, ?, ?, ?)"
  statement: "SELECT * FROM TRANSACTIONS WHERE SENDER_ACCOUNT = ? OR RECEIVER_ACCOUNT = ? ORDER BY CREATED_AT DESC"
  get_daily_withdrawal_total: >
    SELECT SUM(AMOUNT) FROM TRANSACTIONS 
    WHERE SENDER_ACCOUNT = ? 
    AND TX_TYPE = 'WITHDRAWAL' 
    AND DATE(CREATED_AT) = CURDATE()
  log_withdrawal: >
    INSERT INTO TRANSACTIONS (SENDER_ACCOUNT, RECEIVER_ACCOUNT, AMOUNT, TX_TYPE, REMARK) 
    VALUES (?, ?, ?, 'WITHDRAWAL', 'ATM/Counter Withdrawal')

loan:
  insert: "INSERT INTO LOAN_REQUESTS (USER_NAME, EMAIL, LOAN_TYPE, LOAN_AMOUNT) VALUES (?, ?, ?, ?)"

otp:
  save: "INSERT INTO PASSWORD_RESET_OTP (EMAIL, OTP, EXPIRES_AT) VALUES (?, ?, ?)"
  verify: >
    SELECT ID FROM PASSWORD_RESET_OTP 
    WHERE EMAIL = ? AND OTP = ? AND EXPIRES_AT > NOW()
    ORDER BY CREATED_AT DESC LIMIT 1
  delete: "DELETE FROM PASSWORD_RESET_OTP WHERE EMAIL = ?"

user_recovery:
  get_id_by_email: "SELECT USER_ID FROM USERS WHERE EMAIL = ?"
  reset_password: "UPDATE USERS SET PASSWORD_HASH = ? WHERE USER_ID = ?"